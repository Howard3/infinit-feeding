version: '3.8'

services:
  app:
    # Pull the image from GitHub Container Registry
    # Replace 'master' with 'dev' for development environment
    image: ghcr.io/howard3/infinit-feeding:master
    
    container_name: infinit-feeding
    
    # Restart policy - always restart unless explicitly stopped
    restart: unless-stopped
    
    # Port mapping - expose the application on port 3000
    ports:
      - "3000:3000"
    
    # Environment variables from .env file
    environment:
      # S3 Storage Configuration
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - S3_REGION=${S3_REGION}
      
      # Turso Database URI (includes embedded auth token)
      - DB_URI=${DB_URI}
      
      # Clerk Authentication
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - CLERK_PUBLISHABLE_KEY=${CLERK_PUBLISHABLE_KEY}
      
      # API Key for external consumers
      - API_KEY=${API_KEY}
      
      # Environment Mode (production/development)
      - GO_ENV=${GO_ENV:-production}
    
    # Optional: Mount volumes for persistent data
    # Uncomment if you need to override static files
#    volumes:
      # - ./static:/static
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (optional but recommended)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
